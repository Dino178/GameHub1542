<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ultimate Game Hub</title>
<style>
:root{
  --bg:#0b0c0e; --panel:#111214; --muted:#9aa0a6; --accent:#ffd166;
  --card:#141518; --ok:#2ecc71; --bad:#e74c3c;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:#e7eef6}
header{background:var(--panel);padding:18px 24px;text-align:center}
header h1{margin:0;color:var(--accent)}
main{max-width:1100px;margin:18px auto;padding:18px}
.menu, .panel{background:var(--card);padding:16px;border-radius:10px;margin-bottom:14px}
button{background:#1f2226;color:#fff;border:0;padding:8px 12px;border-radius:8px;margin:6px;cursor:pointer}
select,input,textarea{padding:8px;border-radius:8px;border:1px solid #222;background:#0e0f11;color:#fff}
label{color:var(--muted);margin-right:10px}
.controls{margin:8px 0}
.small{font-size:13px;color:var(--muted)}
.leaderboard{background:#0e1012;padding:10px;border-radius:8px;margin-top:12px;max-height:260px;overflow:auto;text-align:left}
.resultline{margin-top:8px;color:var(--muted)}
.achievement{color:var(--accent);font-weight:700;margin-top:6px;display:block}
#reactionArea{width:340px;height:140px;margin:14px auto;border-radius:10px;display:flex;align-items:center;justify-content:center;user-select:none;cursor:pointer}
.color-btn{width:64px;height:64px;border-radius:8px;display:inline-block;margin:6px;border:3px solid rgba(255,255,255,0.06);cursor:pointer}
.hidden{display:none}
.inline{display:inline-block}
.game-title{margin:0 0 8px 0}
ol{margin:8px 0 0 18px;padding:0}
.panel-grid{display:grid;grid-template-columns:1fr;gap:12px}
.top-result{margin-top:8px;padding:10px;background:#0f1113;border-radius:8px}
small.muted{color:var(--muted)}
</style>
</head>
<body>
<header><h1>Ultimate Game Hub</h1></header>
<main>
  <section class="menu" id="mainMenu">
    <h2 class="game-title">Games</h2>
    <div class="controls">
      <button onclick="enterGame('guess')">Guess the Number</button>
      <button onclick="enterGame('math')">Math Quiz</button>
      <button onclick="enterGame('reaction')">Reaction Game</button>
      <button onclick="enterGame('typing')">Gibberish Typing</button>
      <button onclick="enterGame('numMemory')">Number Memory</button>
      <button onclick="enterGame('seqTap')">Sequence Tap</button>
      <button onclick="enterGame('wordChain')">Word Memory Chain</button>
    </div>
    <div class="small">Leaderboards persist in your browser (localStorage). Username is asked after selecting a game and cleared when you return to menu.</div>
  </section>

  <!-- GUESS -->
  <section class="panel hidden" id="panel-guess">
    <h2 class="game-title">Guess the Number</h2>
    <div class="controls">
      <label>Difficulty:
        <select id="guessMode">
          <option value="1-20">Very Easy (1–20)</option>
          <option value="1-50">Easy (1–50)</option>
          <option value="1-100" selected>Normal (1–100)</option>
          <option value="1-250">Hard (1–250)</option>
          <option value="1-500">Very Hard (1–500)</option>
          <option value="1-1000">Extreme (1–1000)</option>
          <option value="1-5000">Nightmare (1–5000)</option>
        </select>
      </label>
      <span id="guessNameArea"></span>
    </div>

    <div id="guessPlayArea"></div>

    <div class="top-result">
      <div class="resultline">Player: <b id="guessPlayer"></b></div>
      <div class="resultline">Attempts: <b id="guessAttempts">0</b> — Time: <b id="guessTime">0.000</b>s</div>
      <div id="guessPersonal" class="small muted"></div>
      <div id="guessAchievements"></div>
    </div>

    <div class="leaderboard" id="lb-guess"></div>
    <div style="margin-top:10px"><button onclick="returnToMenu()">Return to Menu</button></div>
  </section>

  <!-- MATH -->
  <section class="panel hidden" id="panel-math">
    <h2 class="game-title">Math Quiz</h2>
    <div class="controls">
      <label>Questions:
        <select id="mathCount"><option>5</option><option selected>10</option><option>20</option></select>
      </label>
      <label>Difficulty:
        <select id="mathMode"><option value="easy">Easy</option><option value="normal" selected>Normal</option><option value="hard">Hard</option><option value="nightmare">Nightmare</option></select>
      </label>
      <span id="mathNameArea"></span>
    </div>
    <div id="mathPlayArea"></div>
    <div class="top-result">
      <div class="resultline">Player: <b id="mathPlayer"></b> — Correct: <b id="mathCorrect">0</b> / <span id="mathTotal">0</span></div>
      <div class="resultline">Time: <b id="mathTime">0.000</b>s</div>
      <div id="mathPersonal" class="small muted"></div>
      <div id="mathAchievements"></div>
    </div>
    <div class="leaderboard" id="lb-math"></div>
    <div style="margin-top:10px"><button onclick="returnToMenu()">Return to Menu</button></div>
  </section>

  <!-- REACTION -->
  <section class="panel hidden" id="panel-reaction">
    <h2 class="game-title">Reaction Game (Click, not Enter)</h2>
    <div class="controls">
      <label>Rounds:
        <select id="reactionRounds">
          <option>2</option><option selected>3</option><option>5</option><option>7</option><option>10</option><option>15</option><option>25</option>
        </select>
      </label>
      <label>CPU Difficulty:
        <select id="reactionDiff"><option value="easy">Easy</option><option value="normal" selected>Normal</option><option value="hard">Hard</option><option value="nightmare">Nightmare</option></select>
      </label>
      <span id="reactionNameArea"></span>
      <button id="reactionStartBtn">Start</button>
    </div>

    <div id="reactionPlay">
      <div id="reactionArea" style="background:#333;color:#fff;border-radius:8px;display:flex;align-items:center;justify-content:center;height:120px">Press Start</div>
    </div>

    <div class="top-result">
      <div class="resultline">Player: <b id="reactionPlayer"></b></div>
      <div class="resultline">Total Time: <b id="reactionTotal">0.000</b>s</div>
      <div id="reactionPersonal" class="small muted"></div>
      <div id="reactionAchievements"></div>
    </div>

    <div class="leaderboard" id="lb-reaction"></div>
    <div style="margin-top:10px"><button onclick="returnToMenu()">Return to Menu</button></div>
  </section>

  <!-- TYPING -->
  <section class="panel hidden" id="panel-typing">
    <h2 class="game-title">Gibberish Typing</h2>
    <div class="controls">
      <label>Words:
        <select id="typingCount">
          <option>5</option><option>10</option><option>15</option><option selected>20</option>
          <option>25</option><option>30</option><option>35</option><option>40</option>
        </select>
      </label>
      <label>Difficulty:
        <select id="typingMode"><option value="normal" selected>Normal</option><option value="hard">Hard</option><option value="nightmare">Nightmare</option></select>
      </label>
      <span id="typingNameArea"></span>
      <button id="typingStartBtn">Start</button>
    </div>

    <div id="typingPlay" style="margin-top:12px"></div>

    <div class="top-result">
      <div class="resultline">Player: <b id="typingPlayer"></b> — Time: <b id="typingTime">0.000</b>s</div>
      <div id="typingPersonal" class="small muted"></div>
      <div id="typingAchievements"></div>
    </div>

    <div class="leaderboard" id="lb-typing"></div>
    <div style="margin-top:10px"><button onclick="returnToMenu()">Return to Menu</button></div>
  </section>

  <!-- NUMBER MEMORY -->
  <section class="panel hidden" id="panel-numMemory">
    <h2 class="game-title">Number Memory</h2>
    <div class="controls">
      <label>Length:
        <select id="numLen"><option>3</option><option>5</option><option>7</option><option selected>10</option></select>
      </label>
      <label>Difficulty:
        <select id="numMode"><option value="normal" selected>Normal</option><option value="hard">Hard</option><option value="nightmare">Nightmare</option></select>
      </label>
      <span id="numNameArea"></span>
      <button id="numStartBtn">Start</button>
    </div>

    <div id="numPlay" style="margin-top:12px"></div>

    <div class="top-result">
      <div class="resultline">Player: <b id="numPlayer"></b> — Time: <b id="numTime">0.000</b>s</div>
      <div id="numPersonal" class="small muted"></div>
      <div id="numAchievements"></div>
    </div>

    <div class="leaderboard" id="lb-numMemory"></div>
    <div style="margin-top:10px"><button onclick="returnToMenu()">Return to Menu</button></div>
  </section>

  <!-- SEQUENCE TAP -->
  <section class="panel hidden" id="panel-seqTap">
    <h2 class="game-title">Sequence Tap (Colors)</h2>
    <div class="controls">
      <label>Length:
        <select id="seqLen"><option>3</option><option>5</option><option selected>7</option><option>10</option></select>
      </label>
      <label>Difficulty:
        <select id="seqMode"><option value="normal" selected>Normal</option><option value="hard">Hard</option><option value="nightmare">Nightmare</option></select>
      </label>
      <span id="seqNameArea"></span>
      <button id="seqStartBtn">Start</button>
    </div>

    <div id="seqPlay" style="margin-top:12px"></div>

    <div class="top-result">
      <div class="resultline">Player: <b id="seqPlayer"></b> — Time: <b id="seqTime">0.000</b>s</div>
      <div id="seqPersonal" class="small muted"></div>
      <div id="seqAchievements"></div>
    </div>

    <div class="leaderboard" id="lb-seqTap"></div>
    <div style="margin-top:10px"><button onclick="returnToMenu()">Return to Menu</button></div>
  </section>

  <!-- WORD MEMORY CHAIN -->
  <section class="panel hidden" id="panel-wordChain">
    <h2 class="game-title">Word Memory Chain</h2>
    <div class="controls">
      <label>Length:
        <select id="wordLen"><option>3</option><option>5</option><option selected>7</option><option>10</option></select>
      </label>
      <label>Difficulty:
        <select id="wordMode"><option value="normal" selected>Normal</option><option value="hard">Hard</option><option value="nightmare">Nightmare</option></select>
      </label>
      <span id="wordNameArea"></span>
      <button id="wordStartBtn">Start</button>
    </div>

    <div id="wordPlay" style="margin-top:12px"></div>

    <div class="top-result">
      <div class="resultline">Player: <b id="wordPlayer"></b> — Time: <b id="wordTime">0.000</b>s</div>
      <div id="wordPersonal" class="small muted"></div>
      <div id="wordAchievements"></div>
    </div>

    <div class="leaderboard" id="lb-wordChain"></div>
    <div style="margin-top:10px"><button onclick="returnToMenu()">Return to Menu</button></div>
  </section>

</main>

<script>
/* ---------------------------
   Helper utilities & LB storage
---------------------------*/
function now(){ return performance.now(); } // high precision ms
function msToSec(ms){ return ms/1000; }
function lbKey(game, mode){ return 'LH_'+game+'_'+mode; }

function saveToLB(game, mode, entry, comparator){
  const key = lbKey(game,mode);
  let arr = JSON.parse(localStorage.getItem(key) || '[]');
  arr.push(entry);
  arr.sort(comparator);
  arr = arr.slice(0,100);
  localStorage.setItem(key, JSON.stringify(arr));
}

function showLBIn(containerId, game, mode, fmt){
  const key = lbKey(game,mode);
  let arr = JSON.parse(localStorage.getItem(key) || '[]');
  const container = document.getElementById(containerId);
  if(!arr.length){ container.innerHTML = '<i>No scores yet for this mode.</i>'; return; }
  let html = '<b>Top '+Math.min(arr.length,100)+'</b><ol>';
  arr.forEach((e,i)=>{
    html += '<li>' + escapeHTML(e.name) + ' — ' + fmt(e) + '</li>';
  });
  html += '</ol>';
  container.innerHTML = html;
}

function escapeHTML(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* ---------------------------
   Navigation
---------------------------*/
function hideAllPanels(){
  document.querySelectorAll('.panel').forEach(p=>p.classList.add('hidden'));
}
function returnToMenu(){
  // Clear username (they asked it should be forgotten)
  window.__playerName = '';
  hideAllPanels();
  document.getElementById('mainMenu').style.display = 'block';
  // Clear play areas
  document.querySelectorAll('[id$="Play"], [id$="PlayArea"]').forEach(n=>{ if(n) n.innerHTML=''; });
}

/* ---------------------------
   Entry: user clicked a game button
   Ask username AFTER game selected (inside game panel)
---------------------------*/
function enterGame(key){
  hideAllPanels();
  document.getElementById('mainMenu').style.display = 'none';
  const panel = document.getElementById('panel-' + key);
  if(!panel) return;
  panel.classList.remove('hidden');

  // show input area for username inside the panel (per-game)
  const nameAreaId = {
    guess:'guessNameArea', math:'mathNameArea', reaction:'reactionNameArea',
    typing:'typingNameArea', numMemory:'numNameArea', seqTap:'seqNameArea', wordChain:'wordNameArea'
  }[key];

  const nameArea = document.getElementById(nameAreaId);
  nameArea.innerHTML = '';
  const inp = document.createElement('input'); inp.placeholder = 'Your name';
  const startBtn = document.createElement('button'); startBtn.textContent = 'Start';
  nameArea.appendChild(inp); nameArea.appendChild(startBtn);

  startBtn.onclick = ()=>{
    const name = (inp.value || '').trim() || prompt('Enter your name:', 'Player') || 'Player';
    window.__playerName = name;
    nameArea.innerHTML = '<b>Player: </b>' + escapeHTML(name) + ' ';
    // call specific setup
    if(key==='guess') initGuess();
    if(key==='math') initMath();
    if(key==='reaction') initReaction();
    if(key==='typing') initTyping();
    if(key==='numMemory') initNumMemory();
    if(key==='seqTap') initSeqTap();
    if(key==='wordChain') initWordChain();
  };
  inp.addEventListener('keydown', e=>{ if(e.key==='Enter') startBtn.click(); });
}

/* ---------------------------
   Guess the Number
   - Rank by attempts asc, tiebreaker time asc
---------------------------*/
function initGuess(){
  const player = window.__playerName || 'Player';
  document.getElementById('guessPlayer').textContent = player;
  document.getElementById('guessAchievements').innerHTML = '';
  const mode = document.getElementById('guessMode').value;
  document.getElementById('lb-guess').innerHTML = '';
  // UI
  const play = document.getElementById('guessPlayArea');
  play.innerHTML = '';
  const prompt = document.createElement('div');
  const input = document.createElement('input'); input.type='number';
  const submit = document.createElement('button'); submit.textContent='Submit';
  const feedback = document.createElement('div');
  play.appendChild(prompt); play.appendChild(input); play.appendChild(submit); play.appendChild(feedback);

  const [min,max] = mode.split('-').map(n=>Number(n));
  const secret = Math.floor(Math.random()*(max-min+1))+min;
  let attempts = 0;
  const t0 = now();

  prompt.textContent = `I'm thinking of a number between ${min} and ${max}. Guess:`;

  function finish(){
    const elapsed = msToSec(now() - t0);
    document.getElementById('guessTime').textContent = elapsed.toFixed(3);
    // Achievement: first try on any mode
    if(attempts === 1){
      document.getElementById('guessAchievements').innerHTML = '<span class="achievement">🏅 Lucky First Guess!</span>';
    }
    // Nightmare achievement: if max >=5000 and attempts <=10 and elapsed small
    if(max >= 5000 && attempts <= 10){
      document.getElementById('guessAchievements').innerHTML += '<span class="achievement">🔥 Nightmare Conqueror!</span>';
    }
    // Save leaderboard: ranked by attempts asc, time asc
    saveToLB('guess', mode, {name: player, attempts: attempts, time: elapsed, raw: now()}, (a,b)=>{
      if(a.attempts !== b.attempts) return a.attempts - b.attempts;
      return a.time - b.time;
    });
    showLBIn('lb-guess','guess',mode, e => `${e.attempts} attempts — ${e.time.toFixed(3)}s`);
    // Show player's own result separately
    document.getElementById('guessPersonal').textContent = `Your result — ${attempts} attempts, ${elapsed.toFixed(3)}s`;
    // Disable controls
    input.disabled = true;
    submit.disabled = true;
    // Auto-return after short pause
    setTimeout(()=>returnToMenu(), 2500);
  }

  submit.onclick = ()=> {
    if(submit.disabled) return;
    const v = Number(input.value);
    if(Number.isNaN(v)){ feedback.textContent = 'Enter a number'; return; }
    attempts++;
    document.getElementById('guessAttempts').textContent = attempts;
    if(v === secret){
      feedback.textContent = 'Correct!';
      finish();
    } else if(v < secret){
      feedback.textContent = 'Too low!';
    } else feedback.textContent = 'Too high!';
    input.value = '';
    input.focus();
  };
  input.addEventListener('keydown', e=>{ if(e.key==='Enter') submit.click(); });
}

/* ---------------------------
   Math Quiz
   - Score by correct descending; tiebreaker by time ascending
---------------------------*/
function initMath(){
  const player = window.__playerName || 'Player';
  document.getElementById('mathPlayer').textContent = player;
  document.getElementById('mathAchievements').innerHTML = '';
  const totalQuestions = Number(document.getElementById('mathCount').value);
  const mode = document.getElementById('mathMode').value; // easy/normal/hard/nightmare
  const play = document.getElementById('mathPlayArea');
  play.innerHTML = '';
  document.getElementById('mathCorrect').textContent = '0';
  document.getElementById('mathTotal').textContent = totalQuestions;
  document.getElementById('mathTime').textContent = '0.000';
  const t0 = now();
  let correct = 0;
  let qIndex = 0;

  function nextQ(){
    if(qIndex >= totalQuestions){
      const elapsed = msToSec(now() - t0);
      document.getElementById('mathTime').textContent = elapsed.toFixed(3);
      document.getElementById('mathPersonal').textContent = `Your result — ${correct}/${totalQuestions} correct in ${elapsed.toFixed(3)}s`;
      // Save: sort by correct desc, time asc. We'll store negative correct to use ascending sort easier or comparator.
      saveToLB('math', `${mode}_${totalQuestions}`, {name: player, correct: correct, time: elapsed}, (a,b)=>{
        if(a.correct !== b.correct) return b.correct - a.correct;
        return a.time - b.time;
      });
      showLBIn('lb-math','math', `${mode}_${totalQuestions}`, e => `${e.correct}/${totalQuestions} — ${e.time.toFixed(3)}s`);
      if(correct === totalQuestions){
        document.getElementById('mathAchievements').innerHTML = '<span class="achievement">🏅 Perfect Score!</span>';
        if(mode === 'nightmare') document.getElementById('mathAchievements').innerHTML += '<span class="achievement">🔥 Nightmare Genius!</span>';
      } else {
        document.getElementById('mathAchievements').innerHTML = '';
      }
      setTimeout(()=>returnToMenu(), 2500);
      return;
    }

    qIndex++;
    // generate question based on mode
    let a,b,op,answer;
    if(mode === 'easy'){
      a = Math.floor(Math.random()*10)+1; b = Math.floor(Math.random()*10)+1;
      op = ['+','-'][Math.floor(Math.random()*2)];
    } else if(mode === 'normal'){
      a = Math.floor(Math.random()*20)+1; b = Math.floor(Math.random()*12)+1;
      op = ['+','-','*'][Math.floor(Math.random()*3)];
    } else if(mode === 'hard'){
      a = Math.floor(Math.random()*50)+1; b = Math.floor(Math.random()*20)+1;
      op = ['+','-','*','/'][Math.floor(Math.random()*4)];
    } else { // nightmare
      a = Math.floor(Math.random()*100)+1; b = Math.floor(Math.random()*50)+1;
      op = ['+','-','*','/'][Math.floor(Math.random()*4)];
    }
    switch(op){
      case '+': answer = a + b; break;
      case '-': answer = a - b; break;
      case '*': answer = a * b; break;
      case '/': answer = Math.round(a / b); break;
    }

    play.innerHTML = `<div>Q${qIndex}/${totalQuestions}: ${a} ${op} ${b} = ?</div>`;
    const input = document.createElement('input'); input.type='number';
    const submit = document.createElement('button'); submit.textContent='Submit';
    const fb = document.createElement('div');
    play.appendChild(input); play.appendChild(submit); play.appendChild(fb);
    input.focus();

    submit.onclick = ()=> {
      const val = Number(input.value);
      if(!Number.isFinite(val)){ fb.textContent = 'Enter a number'; return; }
      if(val === answer){ correct++; document.getElementById('mathCorrect').textContent = correct; fb.textContent = 'Correct!'; }
      else fb.textContent = `Wrong. Answer: ${answer}`;
      setTimeout(nextQ, 600);
    };
    input.addEventListener('keydown', e=>{ if(e.key === 'Enter') submit.click(); });
  }

  nextQ();
}

/* ---------------------------
   Reaction Game
   - Click only, early click disqualifies
   - Modes by number of rounds; leaderboard per rounds (key: e.g. "3R")
---------------------------*/
function initReaction(){
  const player = window.__playerName || 'Player';
  document.getElementById('reactionPlayer').textContent = player;
  document.getElementById('reactionAchievements').innerHTML = '';
  document.getElementById('reactionPersonal').textContent = '';
  document.getElementById('reactionTotal').textContent = '0.000';
  document.getElementById('lb-reaction').innerHTML = '';
  const rounds = Number(document.getElementById('reactionRounds').value);
  const difficulty = document.getElementById('reactionDiff').value; // affects average wait window maybe
  document.getElementById('reactionPlayer').textContent = player;

  const startBtn = document.getElementById('reactionStartBtn');
  startBtn.disabled = true; // prevent double start
  const area = document.getElementById('reactionArea');
  area.style.background = '#333'; area.textContent = 'Get ready...';
  let currentRound = 0;
  let totalTime = 0;
  let waitingForGreen = false;
  let greenAt = 0;
  let disqualified = false;
  let timeoutHandle = null;

  function cleanupClick(){ area.onclick = null; if(timeoutHandle){ clearTimeout(timeoutHandle); timeoutHandle = null; } }

  function finishAll(){
    cleanupClick();
    startBtn.disabled = false;
    if(disqualified){
      document.getElementById('reactionPersonal').textContent = 'Disqualified (early click). No result saved.';
      document.getElementById('reactionAchievements').innerHTML = '<span class="achievement">❌ Early click — not saved</span>';
      setTimeout(()=>returnToMenu(), 2000);
      return;
    }
    document.getElementById('reactionTotal').textContent = totalTime.toFixed(3);
    document.getElementById('reactionPersonal').textContent = `Your total time: ${totalTime.toFixed(3)}s`;
    // achievement for low total time on many rounds
    if(rounds >= 15 && totalTime / rounds < 0.35){
      document.getElementById('reactionAchievements').innerHTML = '<span class="achievement">⚡ Reaction Nightmare!</span>';
    }
    // Save LB: lower time better
    const modeKey = `${rounds}R_${difficulty}`;
    saveToLB('reaction', modeKey, {name: player, time: totalTime, raw: performance.now()}, (a,b)=> a.time - b.time);
    showLBIn('lb-reaction','reaction', modeKey, e => `${e.time.toFixed(3)}s`);
    setTimeout(()=>returnToMenu(), 2500);
  }

  function startRound(){
    currentRound++;
    if(currentRound > rounds){ finishAll(); return; }
    // show wait
    waitingForGreen = true;
    area.style.background = '#444';
    area.textContent = `Round ${currentRound}/${rounds} — Wait...`;
    // random delay influenced by difficulty
    const base = {easy:800, normal:1200, hard:900, nightmare:600}[difficulty] || 1000;
    const delay = base + Math.random() * 1400;
    // early click handler
    area.onclick = function(){
      if(waitingForGreen){
        disqualified = true;
        cleanupClick();
        area.style.background = '#600';
        area.textContent = 'EARLY! Disqualified.';
        document.getElementById('reactionAchievements').innerHTML = '<span class="achievement">❌ Early click — not saved</span>';
        setTimeout(()=>returnToMenu(), 2000);
      }
    };
    timeoutHandle = setTimeout(()=>{
      waitingForGreen = false;
      greenAt = performance.now();
      area.style.background = '#0a6';
      area.textContent = 'CLICK!';
      // install click handler to capture reaction
      area.onclick = function(){
        if(waitingForGreen) return; // sanity
        const t = performance.now();
        const elapsed = (t - greenAt) / 1000.0;
        totalTime += elapsed;
        area.style.background = '#333';
        area.textContent = `Round ${currentRound}: ${elapsed.toFixed(3)}s`;
        cleanupClick();
        setTimeout(startRound, 650);
      };
    }, delay);
  }

  // If user clicks start button it should begin; but user might have clicked start previously
  startRound();
}

/* ---------------------------
   Gibberish Typing
   - Modes: 5,10,15,20,25,30,35,40 words
   - Must be 100% accurate to qualify for LB
   - Leaderboard by total time ascending
---------------------------*/
const GIBBERISH_WORDS = null; // we'll generate random words programmatically

function randomGibberishWord(minLen=3,maxLen=7){
  const letters='abcdefghijklmnopqrstuvwxyz';
  const len = minLen + Math.floor(Math.random()*(maxLen-minLen+1));
  let w='';
  for(let i=0;i<len;i++) w += letters[Math.floor(Math.random()*letters.length)];
  return w;
}

function initTyping(){
  const player = window.__playerName || 'Player';
  document.getElementById('typingPlayer').textContent = player;
  document.getElementById('typingAchievements').innerHTML = '';
  document.getElementById('typingPersonal').textContent = '';
  document.getElementById('typingTime').textContent = '0.000';
  const n = Number(document.getElementById('typingCount').value);
  const mode = document.getElementById('typingMode').value;
  const words = [];
  for(let i=0;i<n;i++){
    // difficulty influences length
    const len = mode === 'nightmare' ? 6 + Math.floor(Math.random()*6) : mode === 'hard' ? 4 + Math.floor(Math.random()*5) : 3 + Math.floor(Math.random()*4);
    let w = '';
    for(let j=0;j<len;j++) w += String.fromCharCode(97 + Math.floor(Math.random()*26));
    words.push(w);
  }
  const line = words.join(' ');
  const play = document.getElementById('typingPlay');
  play.innerHTML = `<div style="background:#0b0c0d;padding:10px;border-radius:8px">${escapeHTML(line)}</div><input id="typingInput" type="text" style="width:96%;margin-top:8px;padding:8px" placeholder="Type exactly and press Enter" />`;
  const input = document.getElementById('typingInput');
  input.focus();
  const t0 = performance.now();
  function submit(){
    const typed = input.value.trim();
    const elapsed = (performance.now() - t0) / 1000.0;
    document.getElementById('typingTime').textContent = elapsed.toFixed(3);
    document.getElementById('typingPersonal').textContent = `Your time: ${elapsed.toFixed(3)}s — Accuracy: ${typed === line ? '100%' : '✗'}`;
    if(typed === line){
      document.getElementById('typingAchievements').innerHTML = '<span class="achievement">🏆 100% Accuracy!</span>';
      // save to LB
      saveToLB('typing', `${n}W_${mode}`, {name: player, time: elapsed, raw: performance.now()}, (a,b)=> a.time - b.time);
      showLBIn('lb-typing','typing', `${n}W_${mode}`, e => `${e.time.toFixed(3)}s`);
    } else {
      document.getElementById('typingAchievements').innerHTML = '<span class="achievement">❌ Incorrect — not saved</span>';
    }
    input.disabled = true;
    setTimeout(()=>returnToMenu(), 2200);
  }
  input.addEventListener('keydown', e=>{ if(e.key === 'Enter') submit(); });
}

/* ---------------------------
   Number Memory
   - Show digits, hide, user types exact digits no spaces
   - Incorrect -> not saved
---------------------------*/
function initNumMemory(){
  const player = window.__playerName || 'Player';
  document.getElementById('numPlayer').textContent = player;
  document.getElementById('numAchievements').innerHTML = '';
  document.getElementById('numPersonal').textContent = '';
  document.getElementById('numTime').textContent = '0.000';
  const len = Number(document.getElementById('numLen').value);
  const mode = document.getElementById('numMode').value;
  const digits = [];
  for(let i=0;i<len;i++) digits.push(String(Math.floor(Math.random()*10)));
  const play = document.getElementById('numPlay');
  play.innerHTML = `<div style="font-size:20px;letter-spacing:8px;padding:8px;background:#0b0c0d;border-radius:8px">${digits.join(' ')}</div>`;
  const displayMs = Math.max(600, len * (mode==='nightmare' ? 300 : 450));
  setTimeout(()=>{
    play.innerHTML = '';
    const input = document.createElement('input'); input.type='text'; input.placeholder='Type digits without spaces';
    const btn = document.createElement('button'); btn.textContent = 'Submit';
    const fb = document.createElement('div');
    play.appendChild(input); play.appendChild(btn); play.appendChild(fb);
    input.focus();
    const t0 = performance.now();
    btn.onclick = ()=>{
      const typed = (input.value || '').replace(/\s+/g,'');
      const elapsed = (performance.now() - t0)/1000.0;
      document.getElementById('numTime').textContent = elapsed.toFixed(3);
      document.getElementById('numPersonal').textContent = `Your time: ${elapsed.toFixed(3)}s`;
      if(typed === digits.join('')){
        document.getElementById('numAchievements').innerHTML = '<span class="achievement">🏆 Perfect!</span>';
        saveToLB('numMemory', `${len}D_${mode}`, {name: player, time: elapsed, raw: performance.now()}, (a,b)=> a.time - b.time);
        showLBIn('lb-numMemory','numMemory', `${len}D_${mode}`, e => `${e.time.toFixed(3)}s`);
      } else {
        document.getElementById('numAchievements').innerHTML = '<span class="achievement">❌ Incorrect — not saved</span>';
      }
      input.disabled = true; btn.disabled = true;
      setTimeout(()=>returnToMenu(), 2200);
    };
    input.addEventListener('keydown', e=>{ if(e.key==='Enter') btn.click(); });
  }, displayMs);
}

/* ---------------------------
   Sequence Tap (colors)
   - Show color sequence flashes, then user reproduces by clicking colored buttons
   - Incorrect -> not saved
   - Time measured while reproducing
---------------------------*/
function initSeqTap(){
  const player = window.__playerName || 'Player';
  document.getElementById('seqPlayer').textContent = player;
  document.getElementById('seqAchievements').innerHTML = '';
  document.getElementById('seqPersonal').textContent = '';
  const len = Number(document.getElementById('seqLen').value);
  const mode = document.getElementById('seqMode').value;
  const colors = ['#e74c3c','#2ecc71','#3498db','#f1c40f','#9b59b6','#e67e22']; // 6 colors
  const names = ['Red','Green','Blue','Yellow','Purple','Orange'];
  const sequence = [];
  for(let i=0;i<len;i++){
    const idx = Math.floor(Math.random()*colors.length);
    sequence.push(idx);
  }
  const play = document.getElementById('seqPlay');
  play.innerHTML = '<div id="seqFlash" style="min-height:120px;display:flex;align-items:center;justify-content:center"></div>';
  const flash = document.getElementById('seqFlash');
  let idx = 0;
  function flashNext(){
    flash.innerHTML = '';
    if(idx >= sequence.length){
      showPalette();
      return;
    }
    const box = document.createElement('div');
    box.style.width = '100px'; box.style.height = '80px'; box.style.background = colors[sequence[idx]];
    box.style.borderRadius = '8px';
    flash.appendChild(box);
    idx++;
    setTimeout(flashNext, mode==='nightmare' ? 450 : 650);
  }
  function showPalette(){
    flash.innerHTML = '<div style="margin-bottom:8px">Now reproduce the sequence by clicking the colors</div>';
    const palette = document.createElement('div'); palette.style.textAlign='center';
    const startTime = performance.now();
    let pos = 0;
    colors.forEach((c,ci)=>{
      const b = document.createElement('div'); b.className='color-btn'; b.style.background=c; b.title = names[ci];
      b.onclick = ()=>{
        if(pos >= sequence.length) return;
        if(ci !== sequence[pos]){
          document.getElementById('seqAchievements').innerHTML = '<span class="achievement">❌ Wrong — not saved</span>';
          Array.from(palette.children).forEach(x=>x.onclick=null);
          setTimeout(()=>returnToMenu(), 1500);
          return;
        }
        pos++;
        if(pos >= sequence.length){
          const elapsed = (performance.now() - startTime)/1000.0;
          document.getElementById('seqTime').textContent = elapsed.toFixed(3);
          document.getElementById('seqPersonal').textContent = `Your time: ${elapsed.toFixed(3)}s`;
          if(mode === 'nightmare' && elapsed < len*0.35) document.getElementById('seqAchievements').innerHTML = '<span class="achievement">⚡ Nightmare Sequence!</span>';
          saveToLB('seqTap', `${len}S_${mode}`, {name: player, time: elapsed, raw: performance.now()}, (a,b)=> a.time - b.time);
          showLBIn('lb-seqTap','seqTap', `${len}S_${mode}`, e => `${e.time.toFixed(3)}s`);
          Array.from(palette.children).forEach(x=>x.onclick=null);
          setTimeout(()=>returnToMenu(), 1800);
        }
      };
      palette.appendChild(b);
    });
    flash.appendChild(palette);
  }
  flashNext();
}

/* ---------------------------
   Word Memory Chain
   - Show sequence of words, hide, user types back
   - Correct => saved
---------------------------*/
const WORD_BANK = [
  'apple','orange','banana','grape','peach','melon','kiwi','mango','pear','plum',
  'lemon','lime','apricot','berry','cherry','date','fig','guava','papaya','quince',
  'raisin','tamarind','vanilla','walnut','yam','zucchini','coconut','nectarine',
  'olive','radish','spinach','kale','onion','pepper','tomato','garlic','potato','broccoli',
  'carrot','celery','lettuce','mushroom','cabbage','pumpkin','ginger','herb','basil','rosemary'
];

function initWordChain(){
  const player = window.__playerName || 'Player';
  document.getElementById('wordPlayer').textContent = player;
  document.getElementById('wordAchievements').innerHTML = '';
  document.getElementById('wordPersonal').textContent = '';
  const len = Number(document.getElementById('wordLen').value);
  const mode = document.getElementById('wordMode').value;
  const seq = [];
  for(let i=0;i<len;i++) seq.push(WORD_BANK[Math.floor(Math.random()*WORD_BANK.length)]);
  const play = document.getElementById('wordPlay');
  play.innerHTML = `<div style="padding:10px;background:#0b0c0d;border-radius:8px">${escapeHTML(seq.join(' '))}</div>`;
  const displayMs = Math.max(800, len * (mode==='nightmare' ? 600 : 450));
  setTimeout(()=>{
    play.innerHTML = '';
    const input = document.createElement('input'); input.type='text'; input.placeholder='Type words separated by spaces';
    const btn = document.createElement('button'); btn.textContent = 'Submit';
    const fb = document.createElement('div');
    play.appendChild(input); play.appendChild(btn); play.appendChild(fb);
    input.focus();
    const t0 = performance.now();
    btn.onclick = ()=>{
      const typed = (input.value || '').trim().split(/\s+/);
      const elapsed = (performance.now() - t0)/1000.0;
      document.getElementById('wordTime').textContent = elapsed.toFixed(3);
      document.getElementById('wordPersonal').textContent = `Your time: ${elapsed.toFixed(3)}s`;
      let ok = typed.length === seq.length;
      if(ok){
        for(let i=0;i<seq.length;i++){ if(typed[i] !== seq[i]) { ok=false; break; } }
      }
      if(ok){
        document.getElementById('wordAchievements').innerHTML = '<span class="achievement">🏆 Correct!</span>';
        saveToLB('wordChain', `${len}W_${mode}`, {name: player, time: elapsed, raw: performance.now()}, (a,b)=> a.time - b.time);
        showLBIn('lb-wordChain','wordChain', `${len}W_${mode}`, e => `${e.time.toFixed(3)}s`);
      } else {
        document.getElementById('wordAchievements').innerHTML = '<span class="achievement">❌ Incorrect — not saved</span>';
      }
      setTimeout(()=>returnToMenu(), 1800);
    };
    input.addEventListener('keydown', e=>{ if(e.key==='Enter') btn.click(); });
  }, displayMs);
}

/* ---------------------------
   Wiring: attach UI placeholders for name areas and panels
   (create the expected DOM nodes used by the code above)
---------------------------*/
(function attachPlaceholders(){
  // create panel containers if missing (they are in markup) - create nameAreas used by enterGame
  const ids = ['guess','math','reaction','typing','numMemory','seqTap','wordChain'];
  ids.forEach(id=>{
    const nameId = id + 'NameArea';
    if(!document.getElementById(nameId)){
      const el = document.createElement('div'); el.id = nameId; el.className='small';
      const panel = document.getElementById('panel-'+id);
      if(panel) panel.insertBefore(el, panel.firstChild);
    }
  });

  // populate leaderboards initially with placeholders (so showLB works)
  // (no-op; localStorage persists leaderboards between runs)
})();

</script>
</body>
</html>


